# 要件定義ドラフト（v0.1）

本書は`project.md`の内容を踏まえ、実装に着手できる粒度へ詳細化したドラフトです。確定事項と要確認事項を分け、未確定点は`question.md`で質問として列挙しています。

## 1. プロダクト概要（確定）
- 入力のUniProt ID群から、KEGG/Reactomeの経路とSTRINGのPPIネットワークを取得・可視化し、メカニズム/副作用仮説探索を支援する研究用途ツール。
- UIは日本語（英名はツールチップで補足）。

## 2. ペルソナと利用シナリオ（確定）
- 研究者・安全性/薬理担当者・バイオインフォ担当者を主対象。
- 主要ユースケース
  - UC1: 単一IDから関連経路一覧とKEGG/Reactomeビューを表示。
  - UC2: 複数IDから高信頼PPIを構築し、中心性上位ノードをハイライト。
  - UC3: 経路とPPIを横断して共通ノード・富化経路を提示。
  - UC4: 結果をPNG/CSV/JSONとしてエクスポート。

## 3. スコープ（確定/要確認）
- スコープ内
  - 公開API（KEGG/Reactome/STRING/UniProt）の取得・正規化・可視化・簡易富化。
  - ローカルキャッシュ、基本的な再現性確保（レスポンススナップショット）。
- スコープ外（確定）
  - 独自データベースの同梱、商用再配布用ライセンス付与、自動論文生成。
- 保留（要確認）
  - 企業プロキシ/認証環境への対応範囲、オフライン実行の扱い。

## 4. 入出力要件（詳細化）
- 入力
  - ID: 改行/カンマ/タブ区切り。空白はトリム。最大50件/一括（要確認: 上限）。
  - 種: 既定Human（9606）。非Humanは警告と最頻候補提示（計算は可能）。
  - STRINGスコア閾値: 400–990のスライダー、既定700（要確認）。
- 出力
  - 経路タブ: KEGG/Reactome ID・名称・外部リンク・該当ノード数。
  - PPIタブ: ノード・エッジ一覧、中心性スコア、可視化（操作: 拡大/ドラッグ/選択）。
  - 解析タブ: 富化上位経路、共通ノード、上位中心性ノード。
  - エクスポート: `ppi_edges.csv`, `nodes.csv`, `pathways.json`, 可視化PNG。

## 5. 機能要件（詳細化）
- F1: UniProt→KEGG/Reactome経路一覧の表示（目標: 目視で2–5秒以内）。
- F2: STRING PPI取得、`required_score`をUIから調整、ネットワークを再描画。
- F3: 中心性（degree/betweenness/eigenvector）計算、上位N（既定10）をハイライト。
- F4: 富化（ハイパージオメトリの簡易版）、多重検定はBenjamini–Hochberg（要確認）。
- F5: 種切替（警告付き）。
- F6: キャッシュ: TTL既定24h、キー=APIクエリ（種/スコア/入力ID集合を含む）。
- F7: ログ保存: 入力IDハッシュ、API呼数、遅延、失敗率、例外種別。

## 6. 非機能要件（指標）
- パフォーマンス: P50≤2s / P95≤8s（単一ID時の各ビュー初回表示目標）。
- 同時利用: 5ユーザ相当を想定、FastAPI+Uvicornで水平拡張を許容。
- 再現性: APIレスポンスをローカルJSONにスナップショット保存して再読込可。
- 品質: 自動リトライ（指数バックオフ、最大3回）。フォールバックメッセージ整備。
- i18n: 表示は日本語、英語名称はツールチップ併記。

## 7. 画面要件とUIフロー（Streamlit想定）
- 左ペイン: 入力テキスト、種、STRING閾値、表示オプション、実行ボタン。
- タブ構成: 経路 / PPI / 解析 / 出力。
- 画面遷移: 実行→プログレス表示→タブ活性化→結果→ダウンロード。
- 視覚要件: 上位中心性ノードの配色/サイズ差、凡例、ツールチップ必須。

## 8. データモデル/エクスポート（初期設計）
- nodes.csv: `node_id, source(uniprot/string), symbol, degree, betweenness, eigenvector, species`。
- ppi_edges.csv: `source_id, target_id, score, evidence_types, directionality(n/a)`。
- pathways.json: { pathway_id, source(kegg/reactome), name, url, matched_genes[], enrichment_p, q }。
- 文字コード: UTF-8, 改行LF（Windowsでも統一）。

## 9. 外部APIとレート制御
- KEGG REST: `conv/link`でUniProt→gene→pathway。
- Reactome Content Service: UniProt関連経路取得。
- STRING API: `species=9606`, `required_score>=700`初期値。
- UniProt ID mapping: 旧ID/アイソフォームを正規化。
- レート制限: 1ホストあたりQPS制御（既定2req/s）、HTTP 429時は指数バックオフ。

## 10. キャッシュ設計
- 実装: SQLite（キー=ハッシュ、値=JSON、TTL=24h、命中率/サイズをメトリクス化）。
- レイヤ: APIレスポンスレベルと計算結果レベル（中心性/富化）を分離。
- 失効: TTL/バージョン差分/ユーザ明示クリアをサポート。

## 11. ログ/監視（ローカル前提）
- 収集: INFO（開始/終了/所要）、WARN（リトライ/遅延）、ERROR（失敗詳細）。
- 構造化: JSON lines。ユーザ入力はハッシュ化しPII/機密は保持しない。
- メトリクス: API呼数、キャッシュ命中率、平均遅延、失敗率、最大ノード数。

## 12. エラー処理/フォールバック
- ID未解決: 近傍候補提示（同一/アイソフォーム）or スキップ、ログ記録。
- レート制限/タイムアウト: リトライ→キャッシュ→「後で再試行」表示。
- 大規模ネットワーク（>3,000エッジ）: 自動でサブグラフ抽出/警告表示。

## 13. 受け入れ基準（拡張）
- AC1: `Q8WZ42`入力で、PPIとKEGG/Reactome経路が双方表示される。
- AC2: `required_score`を700→900に上げるとエッジ数が減少する。
- AC3: ダウンロードに`ppi_edges.csv`/`nodes.csv`/`pathways.json`/PNGが含まれる。
- AC4: 同一ID再実行でキャッシュヒットが発生しAPI呼数が増えない。
- AC5: 失敗時にユーザフレンドリなエラーと再試行導線が表示される。

## 14. テスト方針
- 単体: APIクライアント、正規化、パーサ、富化、中心性。
- 結合: UniProt→KEGG/Reactome/STRINGのエンドツーエンド疎通（モック併用）。
- UI/E2E: 代表IDでの一連操作、ダウンロード内容のスナップショット一致。
- パフォーマンス: サンプルID集合でP50/P95測定、閾値回帰テスト。

## 15. セキュリティ/ライセンス
- 外部リンク参照（KEGG結果の再配布は不可、メタ情報のみ保持）。
- 出典明記（STRING, Reactome, UniProt）。caller_identity推奨ヘッダ設定。
- 入力履歴の保存はオプション、デフォルトOFF。

## 16. 互換性/移行
- 旧UniProt IDとアイソフォームをID Mappingで正規化し、元IDをエイリアス保存。

## 17. リリース計画（目安）
- M1（1週）: ID正規化＋KEGG/Reactome取得＋キャッシュ。
- M2（1週）: STRING取得＋PPI可視化＋中心性。
- M3（1週）: 富化＋共通ノード＋エクスポート。
- M4（1週）: 例外/ログ/UI磨き＋最終テスト。

## 18. 未確定事項へのリンク
- 詳細はルートの`question.md`を参照し、回答に応じて本書を更新します。

